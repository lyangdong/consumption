<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <title>消费记录</title>

    <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="mobiscroll/js/mobiscroll_002.js" type="text/javascript"></script>
    <script src="mobiscroll/js/mobiscroll_004.js" type="text/javascript"></script>
    <link href="mobiscroll/css/mobiscroll_002.css" rel="stylesheet" type="text/css">
    <link href="mobiscroll/css/mobiscroll.css" rel="stylesheet" type="text/css">
    <script src="mobiscroll/js/mobiscroll.js" type="text/javascript"></script>
    <script src="mobiscroll/js/mobiscroll_003.js" type="text/javascript"></script>
    <script src="mobiscroll/js/mobiscroll_005.js" type="text/javascript"></script>
    <link href="mobiscroll/css/mobiscroll_003.css" rel="stylesheet" type="text/css">
</head>
<body>
<div class="header">
    <ul class="header-list col-xs-12 no-padding">
        <li class="col-xs-3 text-center"><a href="recharge.html">
            <span class="recharge"></span>
            充值
        </a></li>
        <li class="col-xs-6 text-center"><a href="javascript:void (0)">
                <span class="text-center balance">
                    <div>余额</div>
                    <div class="balance-number"></div>
                </span>
        </a></li>
        <li class="col-xs-3 text-center"><a href="time-choose.html">
            <span class="statistics"></span>
            统计
        </a></li>
    </ul>
</div>
<div class="nav">
    <ul>
        <li class="col-xs-3 text-left noP-aside"><a href="javascript:void (0)">账单类型<span class=""></span></a></li>
        <li class="col-xs-6 text-center noP-aside"><a href="javascript:void (0)">交易地点<span class=""></span></a></a></li>
        <li class="col-xs-3 text-right noP-aside"><a href="javascript:void (0)">交易金额<span class=""></span></a></a></li>
    </ul>
</div>
<div class="content-list">
    <div class="box-title">
        <span class="title-time">今日消费</span>
        <span>
                <input id="EndDate" runat="server"  readonly="readonly" style="width:30%;" value="123" />
            </span>
    </div>
    <ul>
        <!--<li class="statistics-box">-->
        <!--<div class="box-content">-->
        <!--<div class="type bg-1 noP-aside">食</div>-->
        <!--<div class=" details">-->
        <!--<div class="address">食堂1号消费窗口</div>-->
        <!--<div class="time">12月3号 17:00</div>-->
        <!--</div>-->
        <!--<div class="money">- 2000</div>-->
        <!--<div style="clear: both"></div>-->
        <!--</div>-->
        <!--</li>-->
    </ul>
</div>
</body>
<script type="text/javascript">
    var obj =getUrlParams();
    var IP ='http://192.168.0.180:8080';
    var openid =obj.openid;

    $('.header-list li:last-child a').attr('href','time-choose.html?openid='+openid);
    var nowDate = getNowFormatDate();
    //    console.log(nowDate)
    consumptionRecord(nowDate);
    getBalance();


    $(function(){
        var currYear = (new Date()).getFullYear();
        var opt={};
        opt.date = {preset : 'date'};
        opt.datetime = {preset : 'datetime'};
        opt.time = {preset : 'time'};
        opt.default = {
            theme: 'android-ics light', //皮肤样式
            display: 'modal', //显示方式
            mode: 'scroller', //日期选择模式
            dateFormat: 'yyyy-mm-dd',
            lang: 'zh',
//            showNow: true,
//            dateOrder:"yymm", //只显示月份
//            nowText: "今天",
            startYear: currYear - 10, //开始年份
            endYear: currYear //结束年份
        };
        $("#EndDate").mobiscroll($.extend(opt['date'], opt['default']));//年月日型
    });
    $('#EndDate').change(function () {
        var date =$('#EndDate').val();
        if(date == nowDate){
            $('.title-time').text('今日消费');
        }else {
            $('.title-time').text(date);
        }
//        console.log($('#EndDate').val());
        consumptionRecord(date);
    });


    function getNowFormatDate() {
        var date = new Date();
        var seperator1 = "-";
        var month = date.getMonth() + 1;
        var strDate = date.getDate();
        if (month >= 1 && month <= 9) {
            month = "0" + month;
        }
        if (strDate >= 0 && strDate <= 9) {
            strDate = "0" + strDate;
        }
        var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate;
        return currentdate;
    }//获取当前时间

    function consumptionRecord(date) {
        $.ajax({
            type:'get',
            url:IP+'/pages/ecards/tradeRecord',
            data:{
                openid:openid,
                date:date
            },
//            rossDomain: true,
//            xhrFields: {            //带上Cookie
//                withCredentials: true
//            },
            success:function (res){
                $('.content-list ul').html(' ');
                var html ='';
                var data =res.data;
//                console.log(data)
                if(data.length==0){
                    html=' <li class="noData">无消费数据</li>'
                }else {
                    html='';
                    for(var i=0;i<res.data.length;i++){
                        if(data[i].tradeType==0){
                            html += ' <li class="statistics-box">\n' +
                                '                <div class="box-content">\n' +
                                '                   <div class="type bg-'+data[i].tradeType +' noP-aside">食</div>\n' +
                                '                   <div class=" details">\n' +
                                '                       <div class="address">'+data[i].termName +'</div>\n' +
                                '                       <div class="time">' +data[i].tradeTime+ '</div>\n' +
                                '                   </div>\n' +
                                '                   <div class="money"><span>-</span> '+data[i].amount+'</div>\n' +
                                '                </div>\n' +
                                '            </li>'
                        }else {
                            html += ' <li class="statistics-box">\n' +
                                '                <div class="box-content">\n' +
                                '                   <div class="type bg-'+data[i].tradeType +' noP-aside">充</div>\n' +
                                '                   <div class=" details">\n' +
                                '                       <div class="address">'+data[i].termName +'</div>\n' +
                                '                       <div class="time">' +data[i].tradeTime+ '</div>\n' +
                                '                   </div>\n' +
                                '                   <div class="money"><span>+</span> '+data[i].amount+'</div>\n' +
                                '                </div>\n' +
                                '            </li>'
                        }
                    }
                }

//                $('.type').each(function (i) {
//                   if($('.type')[i].hasClass('bg-1')){
//                       $('.type')[i].siblings('.money span').html("+");
//                       $('.type')[i].text('充')
//                   }
//                if($('.type').hasClass('bg-1')){
//                    console.log(1)
//                    $(this).siblings('.money span').html("+");
//                    $(this).text('充')
//                }
                $('.content-list ul').append(html);
            },
            error:function (){
                alert("通知列表请求失败，请检查网络")
            }
        });
    }//获取消费记录

    function getBalance() {
        $.ajax({
            type:'get',
            url:IP+'/pages/ecards/currentMoney',
            data:{
                openid:openid
            },
//            rossDomain: true,
//            xhrFields: {            //带上Cookie
//                withCredentials: true
//            },
            success:function (res){
                var data =res.data;
                if(!data){
                    data='?';
                }
                $('.balance-number').text(data)
            },
            error:function (){
                alert("通知列表请求失败，请检查网络")
            }
        });
    }
    function getUrlParams() {
        var queryString = window.location.search.substr(1);

        var argsArr = queryString.split('&');
        if (argsArr[0] === '') {
            argsArr.shift();
        }
        var argsObj = {};
        for (var i = 0; i < argsArr.length; i++) {
            var args = argsArr[i].split('=');
            argsObj[args[0]] = args[1];
        }
        return argsObj;
    }
</script>
</html>